<!DOCTYPE html>
<body>
<div id="pdiv" style="width:100%;height:90vh;background-color: aliceblue">
    <svg style="width:100%;height:100%"></svg>
</div>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    var pdiv = document.getElementById("pdiv");
    var svg = d3.select("svg"),
        // width = +svg.attr("width"),
        // height = +svg.attr("height"),
        width = +pdiv.clientWidth,
        height = +pdiv.clientHeight,
        color = d3.scaleOrdinal(d3.schemeCategory10);

    var a = {id: "a"},
        b = {id: "b"},
        c = {id: "c"},
        //nodes = [a, b, c],
        nodes = [],
        links = [];

    var simulation = d3.forceSimulation(nodes)
            .force("charge", d3.forceManyBody().strength(-100).distanceMax(300))
            .force("link", d3.forceLink(links).distance(30))
            .force("x", d3.forceX())
            .force("y", d3.forceY())
            .alphaTarget(1)
        //.on("tick", ticked)
    ;
    var g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    // const link = svg.append("g")
    //     .attr("fill", "none")
    //     .attr("stroke-width", 1.5)
    //     .selectAll("path")
    //     .data(links)
    //     .join("path")
        // .attr("stroke", d => color(d.type))
        // .attr("marker-end", d => `url(${new URL(`#arrow-${d.type}`, location)})`)
    ;

    var link = g.append("g").attr("stroke", "#000").attr("stroke-width", 1.5)
        //.data(links)
        //.join("path")
        //.attr("d", linkArc)
        .attr("d", d3.linkHorizontal())
        .selectAll(".link");
    var node = g.append("g").attr("stroke", "#fff").attr("stroke-width", 1.5).selectAll(".node");

    simulation.on("tick", () => {
        //link.attr("d", linkArc);
        // link.attr("transform", d => linkArc(d));
        // node.attr("transform", d => `translate(${d.x},${d.y})`);
        ticked();
    });


    restart();

    d3.timeout(function () {
        //links.push({source: a, target: b}); // Add a-b.
        //links.push({source: b, target: c}); // Add b-c.
        //links.push({source: c, target: a}); // Add c-a.
        // createNode();
        // createNode();

        for (var i = 0; i < 256; i++) {
            createNode(i);
        }
        for (var i = 0; i < nodes.length; i++) {
            //createLinks(i);
        }
//        links.push({source: node[nodes.length-1], target: nodes[0]});
        restart();
    }, 1000);
    d3.timeout(function () {
        //simulation.stop();
    }, 1500);

    /*
    d3.interval(function() {
      nodes.pop(); // Remove c.
      links.pop(); // Remove c-a.
      links.pop(); // Remove b-c.
      restart();
    }, 2000, d3.now());
*/

    d3.interval(function () {
        if (links.length < nodes.length) {
            createLinks(links.length);
            restart();
        } else {
            simulation.stop();
        }
//  nodes.push(c); // Re-add c.
//  links.push({source: b, target: c}); // Re-add b-c.
//  links.push({source: c, target: a}); // Re-add c-a.
        //     createNode();
        //}, 2000, d3.now() + 1000);
    }, 200, d3.now());

    function restart() {

        // Apply the general update pattern to the nodes.
        node = node.data(nodes, function (d) {
            return d.id;
        });
        node.exit().remove();
        node = node.enter().append("circle").attr("fill", function (d) {
            return color(d.id);
        }).attr("r", 8).merge(node);

        // Apply the general update pattern to the links.
        link = link.data(links, function (d) {
            return d.source.id + "-" + d.target.id;
        });
        link.exit().remove();
        link = link.enter().append("line")
            .attr("stroke-width", function (d) {
                if (d.source.id <= 8)
                    return 4;
                if (d.source.id <= 32)
                    return 2.5;
                return 1.5;
            }).merge(link);

        // Update and restart the simulation.
        simulation.nodes(nodes);
        simulation.force("link").links(links);
        simulation.alpha(1).restart();
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

    function createNode(nodeId) {
        //var id = "node-" + nodeId;
        var id = nodeId;
        var node = {id: id};
        nodes.push(node);
    }

    function createLinks(nodeId) {
        var targetId = -1;
        if (nodeId === 8) {
            targetId = 0;
        } else if (nodeId < 8) {
            targetId = nodeId + 1;
        } else if (nodeId < 32) {
            targetId = getRandomInt(8);
        } else if (nodeId < 128) {
            targetId = getRandomInt(24) + 8;
        } else {
            targetId = getRandomInt(128) + 32;
        }
        if (targetId === -1) {
            targetId = getRandomInt(10);
            //return;
        }
        console.log("source: " + nodeId + " target=" + targetId)
        links.push({source: nodes[nodeId], target: nodes[targetId]});
    }

    function linkArc(d) {
        const r = Math.hypot(d.target.x - d.source.x, d.target.y - d.source.y);
        return `
    M${d.source.x},${d.source.y}
    A${r},${r} 0 0,1 ${d.target.x},${d.target.y}
  `;
    }

    function createNode1() {
        if (nodes.length === 3)
            return;
        var id = "node-" + nodes.length;
        var node = {id: id};
        if (nodes.length < 1) {
            nodes.push(node);
            return;
        }
        // var targetId = getRandomInt(nodes.length <= 10 ? nodes.length - 1 : 10);
        var targetId = -1;
        if (nodes.length < 10) {
            targetId = nodes.length - 1;
        }
        if (targetId === -1) {
            targetId = getRandomInt(10);
        }
        var maxNodes = nodes.length;
        console.log("source: " + nodes.length + " target=" + targetId)
        var link = {source: node, target: nodes[targetId]};
        nodes.push(node);
        links.push(link);
        var k = getRandomInt(5);
        for (var i = 0; i < k; i++) {
            var tId = getRandomInt(maxNodes);
            //links.push({source: node, target: nodes[tId]});
        }
    }

    // function createLink(node,xlinks,targetId){
    //     if(targetId>0)
    //         return {source: node, target: nodes[targetId]};
    //     while(true) {
    //         var targetId = getRandomInt(10);
    //
    //     }
    // }

    function ticked() {
        node.attr("cx", function (d) {
            return d.x;
        })
            .attr("cy", function (d) {
                return d.y;
            })

        link
            //.attr("d", linkArc)
            .attr("x1", function (d) {
                return d.source.x;
            })
            .attr("y1", function (d) {
                return d.source.y;
            })
            .attr("x2", function (d) {
                return d.target.x;
            })
            .attr("y2", function (d) {
                return d.target.y;
            });
    }

</script>